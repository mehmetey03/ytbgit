name: 🎵 Playlist Güncelleme

on:
  schedule:
    - cron: '0 * * * *'  # Her saat başı otomatik çalışır
  workflow_dispatch:     # Elle çalıştırmak için

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Reponun son halini al
        uses: actions/checkout@v3

      - name: Gerekli paketleri kur
        run: sudo apt update && sudo apt install -y jq curl git

      - name: Playlist klasörünü oluştur
        run: |
          mkdir -p playlist
          rm -f playlist/*

      - name: Playlistleri indir ve oluştur
        run: |
          if [ ! -f link.json ]; then
            echo "❌ link.json bulunamadı!"
            exit 1
          fi

          echo "#EXTM3U" > playlist.m3u

          cat link.json | jq -c '.[]' | while read -r i; do
            name=$(echo "$i" | jq -r '.name')
            url=$(echo "$i" | jq -r '.url')
            filename="playlist/${name}.m3u8"

            echo "🎬 $name indiriliyor..."

            if curl --connect-timeout 10 --max-time 30 -sSL "$url" \
              -H "User-Agent: Mozilla/5.0" \
              -H "Referer: https://live.artofknot.com/" \
              -o "$filename"; then

              echo "✅ $name indirildi."
              echo "#EXTINF:-1,$name" >> playlist.m3u
              echo "https://raw.githubusercontent.com/${{ github.repository }}/main/$filename" >> playlist.m3u

            else
              echo "❌ $name indirilemedi, atlanıyor."
            fi
          done

          mv playlist.m3u playlist/playlist.m3u

      - name: Değişiklikleri commit et ve gönder
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add playlist
          git commit -m "✅ Playlist güncellendi: $(date)" || echo "ℹ️ Değişiklik yok."
          git push
